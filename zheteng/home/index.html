<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="author" content="LooyeaGee"><title>我在往家里路由器上迁东西 | 亦之日记</title><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css?20200712"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><script src="https://cdn.jsdelivr.net/npm/jquery@3.1.1/dist/jquery.min.js"></script><script src="/js/script.js"></script><script src="/js/tocbot.min.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",(e=document.getElementsByTagName("script")[0]).parentNode.insertBefore(t,e)}()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script>$(function(){$("img").each(function(){var t;console.log($(this).data("nobox")),$(this).data("nobox")||(t=document.createElement("a"),$(t).attr("data-fancybox","gallery"),$(t).attr("href",$(this).attr("src")),$(t).attr("data-caption",$(this).attr("alt")),$(this).wrap(t),void 0!==(t=$(this).attr("alt"))&&null!=t&&""!=t&&$(this).after('<div style="text-align:center;text-decoration:none;color:#949292;">'+$(this).attr("alt")+"</div>"))})})</script><style></style><meta name="generator" content="Hexo 4.2.1"></head><body><div class="wrapper"><header><nav class="navbar"><div class="container"><div class="navbar-header header-logo"><a href="/">亦之日记</a></div><div class="menu navbar-right"><a class="menu-item" href="/archives/">文章</a> <a class="menu-item" href="/tag/">标签</a> <a class="menu-item" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a> <a class="menu-item" href="/categories/%E6%8A%98%E8%85%BE/">折腾</a> <a class="menu-item" href="/categories/%E7%A2%8E%E8%AF%AD/">碎语</a> <a class="menu-item" href="/categories/%E5%8E%9F%E5%88%9B%E8%BD%AF%E4%BB%B6/">原创软件</a> <a class="menu-item" href="/about/">关于</a> <a class="menu-item" href="/friendlylink/">友链</a> <a class="menu-item" href="https://snowbao.looyeagee.cn/" target="_blank" rel="noopener">雪宝Web版</a> <a class="menu-item" href="https://photo.looyeagee.cn/" target="_blank" rel="noopener">相册</a></div></div></nav><nav class="navbar-mobile" id="nav-mobile"><div class="container"><div class="navbar-header"><div><a href="/">亦之日记</a></div><div class="menu-toggle" onclick="mobileBtn()">&#9776; 菜单</div></div><div class="menu" id="mobile-menu"><a class="menu-item" href="/archives/">文章</a> <a class="menu-item" href="/tag/">标签</a> <a class="menu-item" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a> <a class="menu-item" href="/categories/%E6%8A%98%E8%85%BE/">折腾</a> <a class="menu-item" href="/categories/%E7%A2%8E%E8%AF%AD/">碎语</a> <a class="menu-item" href="/categories/%E5%8E%9F%E5%88%9B%E8%BD%AF%E4%BB%B6/">原创软件</a> <a class="menu-item" href="/about/">关于</a> <a class="menu-item" href="/friendlylink/">友链</a> <a class="menu-item" href="https://snowbao.looyeagee.cn/" target="_blank" rel="noopener">雪宝Web版</a> <a class="menu-item" href="https://photo.looyeagee.cn/" target="_blank" rel="noopener">相册</a></div></div></nav></header><script>var mobileBtn=function(){var e=document.getElementsByClassName("menu-toggle")[0],t=document.getElementById("mobile-menu");e.classList.contains("active")?(e.classList.remove("active"),t.classList.remove("active")):(e.classList.add("active"),t.classList.add("active"))}</script><div class="main"><div class="container"><div class="post-toc"><div class="tocbot-list"></div><div class="tocbot-list-menu"><a class="tocbot-toc-expand" onclick="expand_toc()">展开目录</a> <a onclick="go_top()">回到顶部</a> <a onclick="go_bottom()">转去底部</a></div></div><script>function expand_toc(){var t=document.querySelector(".tocbot-toc-expand");tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:6,orderedList:!1,scrollSmooth:!0}),t.setAttribute("onclick","collapse_toc()"),t.innerHTML="收起目录"}function collapse_toc(){var t=document.querySelector(".tocbot-toc-expand");tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:1,orderedList:!1,scrollSmooth:!0}),t.setAttribute("onclick","expand_toc()"),t.innerHTML="展开目录"}function go_top(){window.scrollTo(0,0)}function go_bottom(){window.scrollTo(0,document.body.scrollHeight)}document.ready(function(){tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:1,orderedList:!1,scrollSmooth:!0})})</script><article class="post-wrap"><header class="post-header"><h1 class="post-title">我在往家里路由器上迁东西</h1><div class="post-meta">作者: <a itemprop="author" rel="author" href="/">LooyeaGee</a> <span class="post-time">日期: <a href="#">2021-01-20&nbsp;&nbsp;00:08</a> </span><span class="post-category">分类: <a href="/categories/%E6%8A%98%E8%85%BE/">折腾</a> </span><span class="post-category">访问量:<span id="article_pv">加载中...</span></span></div></header><div class="post-content"><h1 id="说在前头"><a href="#说在前头" class="headerlink" title="说在前头"></a>说在前头</h1><p>上次文章还没写完呢，先鸽着。我已经决定不续费阿里云服务器了（费用和资源利用率问题）。但是少部分项目，如SnowBao雪宝，迁移到云函数上要改很多东西，我懒得动，所以还是要有一个简单的服务器。要不自己部署一个？</p><h1 id="开始折腾"><a href="#开始折腾" class="headerlink" title="开始折腾"></a>开始折腾</h1><p>回家了，得继续折腾！为此，我入手了一台入门软路由，配置如下：</p><table><thead><tr><th>硬件</th><th>型号</th></tr></thead><tbody><tr><td>主板</td><td>升腾NI945W-3</td></tr><tr><td>CPU</td><td>Intel(R) Atom(TM) CPU D2550 x86_64</td></tr><tr><td>内存</td><td>金士顿DDR3 2G</td></tr><tr><td>SSD</td><td>慧荣SM2244LTAB 8G</td></tr></tbody></table><p>配置好像不咋地？没关系，我部署的应用不怎么占内存和CPU的。卖家帮忙刷好了eSir编译的OpenWrt，由于我家联通宽带有公网IPv4地址，所以我就想说干脆搭一台宝塔服务器放家里算了。我部署的一些网站并不要求高可用，故家里短暂停电也没有太大关系。</p><p>我没有将其作为主路由使用，而是作为客户端使用，那么它的路由功能相当于废了！因为我不想引起现有路由配置的改变，懒得动。</p><h1 id="哪来的公网IPv4地址"><a href="#哪来的公网IPv4地址" class="headerlink" title="哪来的公网IPv4地址"></a>哪来的公网IPv4地址</h1><p>现在运营商一般拨号后给的是内网IP地址了，不像十几年前我家刚接入ADSL 12M铜线宽带每个人还有一个独立IP，甚至80端口还是开放的。现在买宽带的人越来越多，而我们国家被分配的IPv4地址才3亿多个，很少很少，所以运营商只能使用NAT技术来缓解公网IPv4地址紧缺的情况。但是！长沙联通可以在宽带账号后面加上<code>@changsha</code>，其他地区联通可以加上<code>@pppoe</code>拨号来获取公网IPv4地址，如果不行或者是其他运营商请致电客服获取公网IPv4地址。</p><h1 id="我家是光猫拨号咋整"><a href="#我家是光猫拨号咋整" class="headerlink" title="我家是光猫拨号咋整"></a>我家是光猫拨号咋整</h1><p>现在安装网络的时候，师傅帮你在光猫里面配置好了宽带账号密码啥的，而且光猫的<code>DMZ</code>功能好像是假的，所以我们需要用路由器来拨号。我们可以去网上搜索光猫的超级管理员账号密码，然后进Telnet后台把宽带账号密码查出来备份，最后在网页管理端把连接方式修改为桥接模式（Bridge ）即可。然后我们可以重置路由器，使用PPPoE拨号上网即可。</p><h1 id="IPv4地址变化怎么搞"><a href="#IPv4地址变化怎么搞" class="headerlink" title="IPv4地址变化怎么搞"></a>IPv4地址变化怎么搞</h1><p>我们家庭宽带不像企业专线一样有固定IP地址，我们的IP地址都是由运营商随机分配的，所以我们做域名解析的时候咋弄？最简单的就是路由器的DDNS功能了，像我家TP-LINK的路由器自己有DDNS，注册一个账号登录即可，会给你一个域名，然后把自己想要解析的子域名做<code>CNAME</code>到DDNS的域名即可。我总觉得这样不是很优雅，我的域名解析商是DNSPod，提供了API接口供修改解析。刚好Python里面有朋友封装了这些接口，模块名是：dns-dnspod，使用<code>pip3 install dns-dnspod</code>即可。所以我们可以使用这个来给域名做A记录。我们先去创建一个解析记录，然后通过API取得record_id，然后定时修改解析记录即可。</p><p>我用Python相关代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> pydnspod</span><br><span class="line">user_id = <span class="string">'&#123;YOUR_DNSPOD_ID&#125;'</span></span><br><span class="line">user_token = <span class="string">'&#123;YOUR_DNSPOD_KEY&#125;'</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    ip = requests.get(<span class="string">"https://ip.yinghualuo.cn/getip"</span>).text <span class="comment"># 取得公网IP地址，如果你是软路由拨号可以直接取系统的ip地址。</span></span><br><span class="line">    <span class="comment"># ip = json.loads(requests.get("http://pv.sohu.com/cityjson").text[19:-1])["cip"] 备用</span></span><br><span class="line">    dp = pydnspod.connect(user_id, user_token)</span><br><span class="line">    <span class="comment"># print(dp.record.record_id("&#123;主域名如baidu.com&#125;","主机记录如www")) 这个是来获取record_id的 获取后填在下面即可</span></span><br><span class="line">    print(json.dumps(dp.record.modify(<span class="string">"&#123;主域名如baidu.com&#125;"</span>,<span class="string">"&#123;上面获取到的record_id&#125;"</span>,<span class="string">"&#123;主机记录如www&#125;"</span>,<span class="string">"&#123;记录类型&#125;"</span>,ip)))</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>然后使用crontab创建定时任务，每几分钟运行一次即可。</p><h1 id="OpenWrt怎么安装宝塔"><a href="#OpenWrt怎么安装宝塔" class="headerlink" title="OpenWrt怎么安装宝塔"></a>OpenWrt怎么安装宝塔</h1><p>OpenWrt本身应该不能安装宝塔，但是这个固件有Docker呀，我们可以pull一个CentOS最新的镜像，然后执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --privileged -e <span class="string">"container=docker"</span> -p 443:443 -p 8000-9000:8000-9000 --name=<span class="string">"centos"</span> --restart=always 300e315adb2f /usr/sbin/init</span><br></pre></td></tr></table></figure><p>就创建了一个新的容器，并暴露了一些端口。为啥不暴露80，是因为家庭宽带的80端口被封啦。然后再在容器里面执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y wget &amp;&amp; wget -O install.sh http://download.bt.cn/install/install_6.0.sh &amp;&amp; sh install.sh</span><br></pre></td></tr></table></figure><p>等一会儿就OK啦，记得把默认的8888端口地址改改。</p><h1 id="怎么守护Python后端服务"><a href="#怎么守护Python后端服务" class="headerlink" title="怎么守护Python后端服务"></a>怎么守护Python后端服务</h1><p>宝塔安装Supervisor进程管理器，添加守护进程即可。用到Python虚拟环境的可以写上虚拟环境里Python的完整路径来执行程序。</p><h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>用了几天感觉这个小主板还是挺不错的，不卡也稳定。百来块钱，体验到了非一般的感觉~</p><p>目前SnowBao雪宝已经完全迁移到了软路由上了，希望大家用的开心。</p></div><section class="post-copyright"><p class="copyright-item"><span>文章作者:</span> <span>LooyeaGee</span></p><p class="copyright-item"><span>文章链接:</span> <span><a href="https://looyeagee.cn/zheteng/home/">https://looyeagee.cn/zheteng/home/</a></span></p><p class="copyright-item"><span>版权声明:</span> <span>本博客采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a>进行许可</span></p></section><section class="post-tags"><div><span>标签:</span> <span class="tag"><a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8/"># 服务器</a> <a href="/tags/CentOS/"># CentOS</a> <a href="/tags/OpenWrt/"># OpenWrt</a></span></div><div><a href="javascript:window.history.back();">返回</a> <span>&nbsp;&nbsp; /&nbsp;&nbsp; </span><a href="/archives/">首页</a></div></section><section class="post-nav"><a class="next" rel="next" href="/zheteng/tcb/">我在用云函数和Serverless</a></section><br><br><section id="comments" class="comments"><style>.comments{margin:30px;padding:10px;background:#fff}@media screen and (max-width:800px){.comments{margin:auto;padding:10px;background:#fff}}</style><div class="valine_comment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>new Valine({el:".valine_comment",app_id:"GGS59T6lHdF3dH3fhiSJwu4G-MdYXbMMI",app_key:"mqefY3TJMDaBRqc44I7OdYtY",placeholder:"说点什么呗",notify:"false",verify:"false",avatar:"monsterid",visitor:!0})</script></section></article></div></div><footer id="footer" class="footer">访问总量：<span id="pv">加载中...</span><br><a href="http://beian.miit.gov.cn" target="__blank">湘ICP备19026259号-1</a> • <a target="_blank" style="line-height:18px" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=43018102000289"><img src="https://cdn.looyeagee.cn/blog/img/wangan.png" data-nobox="true" style="width:16px;height:16px;vertical-align:sub">湘公网安备43018102000289号</a><br>Copyright &copy; 2020 <a href="https://looyeagee.cn/">亦之日记</a> 的博客 • Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></footer><script>const path_name=decodeURI(window.location.pathname);$.ajax({type:"POST",url:"https://api.looyeagee.cn/api/visit"+path_name,success:function(t){$("#article_pv").html(t.hits),$("#pv").html(t.all)},error:function(t){}})</script></div></body></html>