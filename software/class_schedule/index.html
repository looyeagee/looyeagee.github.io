<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="author" content="LooyeaGee"><title>[开源]自动获取当天课表并发送至邮箱 | 亦之日记</title><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css?20200712"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><script src="https://cdn.jsdelivr.net/npm/jquery@3.1.1/dist/jquery.min.js"></script><script src="/js/script.js"></script><script src="/js/tocbot.min.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",(e=document.getElementsByTagName("script")[0]).parentNode.insertBefore(t,e)}()</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script>$(function(){$("img").each(function(){var t;console.log($(this).data("nobox")),$(this).data("nobox")||(t=document.createElement("a"),$(t).attr("data-fancybox","gallery"),$(t).attr("href",$(this).attr("src")),$(t).attr("data-caption",$(this).attr("alt")),$(this).wrap(t),void 0!==(t=$(this).attr("alt"))&&null!=t&&""!=t&&$(this).after('<div style="text-align:center;text-decoration:none;color:#949292;">'+$(this).attr("alt")+"</div>"))})})</script><style></style><meta name="generator" content="Hexo 4.2.1"></head><body><div class="wrapper"><header><nav class="navbar"><div class="container"><div class="navbar-header header-logo"><a href="/">亦之日记</a></div><div class="menu navbar-right"><a class="menu-item" href="/archives/">文章</a> <a class="menu-item" href="/tag/">标签</a> <a class="menu-item" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a> <a class="menu-item" href="/categories/%E6%8A%98%E8%85%BE/">折腾</a> <a class="menu-item" href="/categories/%E7%A2%8E%E8%AF%AD/">碎语</a> <a class="menu-item" href="/categories/%E5%8E%9F%E5%88%9B%E8%BD%AF%E4%BB%B6/">原创软件</a> <a class="menu-item" href="/about/">关于</a> <a class="menu-item" href="/friendlylink/">友链</a> <a class="menu-item" href="https://snowbao.looyeagee.cn/" target="_blank" rel="noopener">雪宝Web版</a> <a class="menu-item" href="https://photo.looyeagee.cn/" target="_blank" rel="noopener">相册</a></div></div></nav><nav class="navbar-mobile" id="nav-mobile"><div class="container"><div class="navbar-header"><div><a href="/">亦之日记</a></div><div class="menu-toggle" onclick="mobileBtn()">&#9776; 菜单</div></div><div class="menu" id="mobile-menu"><a class="menu-item" href="/archives/">文章</a> <a class="menu-item" href="/tag/">标签</a> <a class="menu-item" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a> <a class="menu-item" href="/categories/%E6%8A%98%E8%85%BE/">折腾</a> <a class="menu-item" href="/categories/%E7%A2%8E%E8%AF%AD/">碎语</a> <a class="menu-item" href="/categories/%E5%8E%9F%E5%88%9B%E8%BD%AF%E4%BB%B6/">原创软件</a> <a class="menu-item" href="/about/">关于</a> <a class="menu-item" href="/friendlylink/">友链</a> <a class="menu-item" href="https://snowbao.looyeagee.cn/" target="_blank" rel="noopener">雪宝Web版</a> <a class="menu-item" href="https://photo.looyeagee.cn/" target="_blank" rel="noopener">相册</a></div></div></nav></header><script>var mobileBtn=function(){var e=document.getElementsByClassName("menu-toggle")[0],t=document.getElementById("mobile-menu");e.classList.contains("active")?(e.classList.remove("active"),t.classList.remove("active")):(e.classList.add("active"),t.classList.add("active"))}</script><div class="main"><div class="container"><div class="post-toc"><div class="tocbot-list"></div><div class="tocbot-list-menu"><a class="tocbot-toc-expand" onclick="expand_toc()">展开目录</a> <a onclick="go_top()">回到顶部</a> <a onclick="go_bottom()">转去底部</a></div></div><script>function expand_toc(){var t=document.querySelector(".tocbot-toc-expand");tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:6,orderedList:!1,scrollSmooth:!0}),t.setAttribute("onclick","collapse_toc()"),t.innerHTML="收起目录"}function collapse_toc(){var t=document.querySelector(".tocbot-toc-expand");tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:1,orderedList:!1,scrollSmooth:!0}),t.setAttribute("onclick","expand_toc()"),t.innerHTML="展开目录"}function go_top(){window.scrollTo(0,0)}function go_bottom(){window.scrollTo(0,document.body.scrollHeight)}document.ready(function(){tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:1,orderedList:!1,scrollSmooth:!0})})</script><article class="post-wrap"><header class="post-header"><h1 class="post-title">[开源]自动获取当天课表并发送至邮箱</h1><div class="post-meta">作者: <a itemprop="author" rel="author" href="/">LooyeaGee</a> <span class="post-time">日期: <a href="#">2020-02-23&nbsp;&nbsp;14:36</a> </span><span class="post-category">分类: <a href="/categories/%E5%8E%9F%E5%88%9B%E8%BD%AF%E4%BB%B6/">原创软件</a> </span><span class="post-category">访问量:<span id="article_pv">加载中...</span></span></div></header><div class="post-content"><h3 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h3><p>学校教务系统更换成了强智教务系统<em>（吐槽：花了200万的教务系统连个手机客户端都没有，且根本没对手机进行适配）</em>，导致没有较好的手机客户端能适配，很多同学们用的第三方客户端都出现了乱码或者缺课的现象。由于我手机开发实在不行，所以我萌生了每天0点自动发送今天课表加本周课表到我自己的邮箱的这么一个想法。</p><h3 id="二、抓包分析"><a href="#二、抓包分析" class="headerlink" title="二、抓包分析"></a>二、抓包分析</h3><h4 id="1、登录"><a href="#1、登录" class="headerlink" title="1、登录"></a>1、登录</h4><p>我们打开官网后，输入账号密码点击登录按钮，发现第一个包是<code>POST /Logon.do?method=logon&amp;flag=sess</code>返回了一串字符，到这里不清楚这是干啥的；然后第二个包是<code>POST /Logon.do?method=logon</code>，传入了<code>userAccount(学号)</code>和<code>encoded(密文)</code>返回了一个重定向，第三个包是访问了刚刚的重定向网址结果又重定向到了<code>/jsxsd/framework/xsMain.jsp</code>主页。</p><p>分析到这里，我们发现密码是被加密了再传输的。我第一个想到的是右键查看源代码看看密文是怎么来的吧，登录按钮直接绑定了js函数<code>login()</code>，跳转到这里发现如下代码：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>($(<span class="string">"#userAccount"</span>).val() == <span class="string">""</span>) &#123;</span><br><span class="line">		$(<span class="string">"#showMsg"</span>).text(<span class="string">"请输入账号"</span>);</span><br><span class="line">		$(<span class="string">"#userAccount"</span>).focus();</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>($(<span class="string">"#userPassword"</span>).val() == <span class="string">""</span>) &#123;</span><br><span class="line">		$(<span class="string">"#showMsg"</span>).text(<span class="string">"请输入密码"</span>);</span><br><span class="line">		$(<span class="string">"#userPassword"</span>).focus();</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">var</span> strUrl = <span class="string">"/Logon.do?method=logon&amp;flag=sess"</span>;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	$.ajax( &#123;</span><br><span class="line">		url:strUrl,</span><br><span class="line">  		type:<span class="string">"post"</span>,</span><br><span class="line">  		cache:<span class="literal">false</span>,</span><br><span class="line">		dataType:<span class="string">"text"</span>,</span><br><span class="line">		success:<span class="function"><span class="keyword">function</span>(<span class="params">dataStr</span>) </span>&#123;</span><br><span class="line">			<span class="keyword">if</span>(dataStr==<span class="string">"no"</span>)&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	 		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	 			<span class="keyword">var</span> scode=dataStr.split(<span class="string">"#"</span>)[<span class="number">0</span>];</span><br><span class="line">		     	<span class="keyword">var</span> sxh=dataStr.split(<span class="string">"#"</span>)[<span class="number">1</span>];</span><br><span class="line">		     	<span class="keyword">var</span> code=<span class="built_in">document</span>.getElementById(<span class="string">"userAccount"</span>).value+<span class="string">"%%%"</span>+<span class="built_in">document</span>.getElementById(<span class="string">"userPassword"</span>).value;</span><br><span class="line">			 	<span class="keyword">var</span> encoded=<span class="string">""</span>;</span><br><span class="line">				<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;code.length;i++)&#123;</span><br><span class="line">					<span class="keyword">if</span>(i&lt;<span class="number">20</span>)&#123;</span><br><span class="line">						encoded=encoded+code.substring(i,i+<span class="number">1</span>)+scode.substring(<span class="number">0</span>,<span class="built_in">parseInt</span>(sxh.substring(i,i+<span class="number">1</span>)));</span><br><span class="line">					    scode = scode.substring(<span class="built_in">parseInt</span>(sxh.substring(i,i+<span class="number">1</span>)),scode.length);</span><br><span class="line">					&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">					    encoded=encoded+code.substring(i,code.length);</span><br><span class="line">					    i=code.length;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="built_in">document</span>.getElementById(<span class="string">"encoded"</span>).value=encoded;</span><br><span class="line">				<span class="keyword">if</span>(<span class="string">"logon"</span>!=<span class="string">"logonLdap"</span>)&#123;</span><br><span class="line">					<span class="built_in">document</span>.getElementById(<span class="string">"userPassword"</span>).value=<span class="string">""</span>;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="built_in">document</span>.getElementById(<span class="string">"loginForm"</span>).submit();</span><br><span class="line">	 		&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		error:<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	 		alert(<span class="string">"计算异常！"</span>);</span><br><span class="line">		&#125;</span><br><span class="line">  	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现了猫腻，原来这里访问了第一个包得到的字符串是一串可以说是<code>密钥</code>的东西；通过一系列算法把密码加密成密文，我把这段翻译成了Python代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt_password</span><span class="params">(xuehao, password, dataStr)</span>:</span></span><br><span class="line">    sCode, sxh = dataStr.split(<span class="string">"#"</span>)</span><br><span class="line">    code = xuehao + <span class="string">"%%%"</span> + password</span><br><span class="line">    encoded = <span class="string">""</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; len(code):</span><br><span class="line">        <span class="keyword">if</span> i &lt; <span class="number">20</span>:</span><br><span class="line">            encoded = encoded + code[i:i + <span class="number">1</span>] + sCode[<span class="number">0</span>:int(sxh[i:i + <span class="number">1</span>])]</span><br><span class="line">            sCode = sCode[int(sxh[i:i + <span class="number">1</span>]):len(sCode)]</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            encoded = encoded + code[i:len(code)]</span><br><span class="line">            i = len(code)</span><br><span class="line">    <span class="keyword">return</span> encoded</span><br></pre></td></tr></table></figure><p>得到密文之后，就可以正常登录了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">s = requests.session()</span><br><span class="line">r = s.post(url=<span class="string">"http://xk.csust.edu.cn/Logon.do?method=logon&amp;flag=sess"</span>)</span><br><span class="line"></span><br><span class="line">r = s.post(url=<span class="string">"http://xk.csust.edu.cn/Logon.do?method=logon"</span>,</span><br><span class="line">           data=&#123;<span class="string">"userAccount"</span>: xh, <span class="string">"encoded"</span>: encrypt_password(xh, mm, r.text)&#125;)</span><br></pre></td></tr></table></figure><h4 id="2、-可选-获得姓名"><a href="#2、-可选-获得姓名" class="headerlink" title="2、[可选]获得姓名"></a>2、[可选]获得姓名</h4><p>登录后重定向两次到了<code>/jsxsd/framework/xsMain.jsp</code>，里面含有名字可以取出，查看源码容易知道用正则</p><p><code>&lt;span class=&quot;glyphicon-class&quot;&gt;(.*?)&lt;/span&gt;</code>可以返回的第一个数据就是姓名。</p><h4 id="3、-可选-获得当前周"><a href="#3、-可选-获得当前周" class="headerlink" title="3、[可选]获得当前周"></a>3、[可选]获得当前周</h4><p>我们发现主页是多个iframe框架拼凑的，第几周的信息在<code>/jsxsd/framework/xsMain_new.jsp</code>路径下，查看源码容易知道用正则<code>&gt;(.*?)&lt;/span&gt;/(.*?)$</code>可以返回第几周和总周数。</p><h4 id="4、获得课表"><a href="#4、获得课表" class="headerlink" title="4、获得课表"></a>4、获得课表</h4><p>分析包容易发现<code>/jsxsd/framework/main_index_loadkb.jsp</code>就是课表的网页，传入的<code>rq</code>参数是当天的日期，传入日期不同课表显示不同。但是课表名字过长的话会显示..导致显示不全，刚开始我还以为是前端CSS造成的，结果是后端就处理好的！汗！幸好我们将鼠标滑动的时候能显示出详细的信息，所以通过查看源码可以得到课程的完整名称和地点。课程的详细信息在<code>td标签</code>里的<code>p标签</code>的<code>title属性</code>里。我们把所有的数据打包成一个二维数组，供生成图片使用。</p><p>代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">r = s.post(url=<span class="string">"http://xk.csust.edu.cn/jsxsd/framework/main_index_loadkb.jsp"</span>, data=&#123;<span class="string">"rq"</span>: time.strftime(<span class="string">"%Y-%m-%d"</span>, timeStruct)&#125;)</span><br><span class="line"></span><br><span class="line">table_data = []  <span class="comment"># 全部数据数组</span></span><br><span class="line">table_header = re.findall(<span class="string">r'&lt;th[^&gt;]*"&gt;(.*?)&lt;/th&gt;'</span>, r.text)  <span class="comment"># 表头</span></span><br><span class="line">table_data.append(table_header)</span><br><span class="line">header_length = len(table_header)  <span class="comment"># 取得几列 也就是表头个数</span></span><br><span class="line">all_td_content = re.findall(<span class="string">r'&lt;td[^&gt;]*&gt;(.*?)&lt;/td&gt;'</span>, r.text.replace(<span class="string">"\t"</span>, <span class="string">""</span>).replace(<span class="string">"\n"</span>, <span class="string">""</span>))  <span class="comment"># 取得所有td内容 删除换行符号和制表符</span></span><br><span class="line"></span><br><span class="line">temp = []  <span class="comment"># 临时存储单行的数据</span></span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> enumerate(all_td_content):</span><br><span class="line">    <span class="keyword">if</span> i % header_length == <span class="number">0</span>:  <span class="comment"># 说明这是这一行的第一个数据 也就是表格中的第几节</span></span><br><span class="line">        dijijie = v.split(<span class="string">"&lt;br/&gt;"</span>)</span><br><span class="line">        temp.append(<span class="string">"\n%s\n%s\n%s"</span> % (dijijie[<span class="number">0</span>], dijijie[<span class="number">1</span>], dijijie[<span class="number">2</span>]))</span><br><span class="line">    <span class="keyword">else</span>:  <span class="comment"># 否则就是具体课程啦</span></span><br><span class="line">        name = findMiddle(v, <span class="string">"课程名称："</span>, <span class="string">"&lt;br/&gt;"</span>)</span><br><span class="line">        room = findMiddle(v, <span class="string">"上课地点："</span>, <span class="string">"'"</span>)</span><br><span class="line">        temp.append(<span class="string">"\n"</span> + name + <span class="string">"\n\n"</span> + room + <span class="string">"\n"</span>)</span><br><span class="line">    <span class="keyword">if</span> (i + <span class="number">1</span>) % header_length == <span class="number">0</span>:  <span class="comment"># 检测目前td内容是不是一行的最后一个数据 如果是就把这一整行给加入总的二维表</span></span><br><span class="line">        table_data.append(temp)</span><br><span class="line">        temp = []</span><br><span class="line"></span><br><span class="line">print(table_data)</span><br></pre></td></tr></table></figure><p>生成的数据长这个样子</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"周/节次"</span>,</span><br><span class="line">        <span class="string">"星期一"</span>,</span><br><span class="line">        <span class="string">"星期二"</span>,</span><br><span class="line">        <span class="string">"星期三"</span>,</span><br><span class="line">        <span class="string">"星期四"</span>,</span><br><span class="line">        <span class="string">"星期五"</span>,</span><br><span class="line">        <span class="string">"星期六"</span>,</span><br><span class="line">        <span class="string">"星期日"</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"\n第一大节\n(01,02小节)\n08:00-09:40"</span>,</span><br><span class="line">        <span class="string">"\n人工智能概论\n\n云综教[假装打码]\n"</span>,</span><br><span class="line">        <span class="string">"\n英语听说写译综合\n\n云综教[假装打码]\n"</span>,</span><br><span class="line">        <span class="string">"\n软件项目管理及案例\n\n云文科[假装打码]\n"</span>,</span><br><span class="line">        <span class="string">"\n软件工程经济学\n\n云文科[假装打码]\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"\n第二大节\n(03,04小节)\n10:00-11:40"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"\n第三大节\n(05,06小节)\n14:00-15:40"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n人工智能概论\n\n云综教[假装打码]\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"\n第四大节\n(07,08小节)\n16:00-17:40"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span></span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">        <span class="string">"\n第五大节\n(09,10小节)\n19:30-21:10"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span>,</span><br><span class="line">        <span class="string">"\n\n\n\n"</span></span><br><span class="line">    ]</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>然后参考<code>https://www.cnblogs.com/xiamibk/p/10299609.html</code>的文章，执行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">create_table_img(table_data, xh + <span class="string">'('</span> + rq + <span class="string">')课表.png'</span>, font=<span class="string">"font.ttf"</span>,</span><br><span class="line">                 describe=<span class="string">'以上数据仅供参考，作者：亦之(looyeagee)博客地址：https://looyeagee.cn/'</span>,</span><br><span class="line">                 table_title=xm + <span class="string">'('</span> + rq + <span class="string">')[%s]的课程表'</span> % now_zhou)</span><br></pre></td></tr></table></figure><p>将二维数组表转换成图片就是这样：</p><p><img src="https://cdn.looyeagee.cn/blog/img/2020/02/1015774712.png-blog" alt="图1:课表截图"></p><h3 id="三、自动发送邮件"><a href="#三、自动发送邮件" class="headerlink" title="三、自动发送邮件"></a>三、自动发送邮件</h3><p>首先我们在163邮箱里创建一个授权码当做第三方客户端的密码，然后就可以将当天的课表和本周的课表图发出去了。</p><h4 id="1、获得当天课表"><a href="#1、获得当天课表" class="headerlink" title="1、获得当天课表"></a>1、获得当天课表</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">t = table_data.copy()  <span class="comment"># 复制一份刚刚生成的二维表</span></span><br><span class="line"><span class="keyword">del</span> (t[<span class="number">0</span>])  <span class="comment"># 删除第一行 也就是星期几的那一行</span></span><br><span class="line">table_data_90 = [[row[i] <span class="keyword">for</span> row <span class="keyword">in</span> t] <span class="keyword">for</span> i <span class="keyword">in</span> range(len(t[<span class="number">0</span>]))]  <span class="comment"># 矩阵转置</span></span><br><span class="line">today = <span class="string">"你的今日课表如下：&lt;br&gt;"</span></span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> enumerate(table_data_90[<span class="number">0</span>]):</span><br><span class="line">    detail_kecheng = table_data_90[datetime.datetime.now().weekday() + <span class="number">1</span>][i].split()</span><br><span class="line">    <span class="keyword">if</span> len(detail_kecheng) != <span class="number">0</span>:</span><br><span class="line">        today = today + <span class="string">"%s:%s(%s)&lt;br&gt;"</span> % (v.split()[<span class="number">2</span>], detail_kecheng[<span class="number">0</span>], detail_kecheng[<span class="number">1</span>])</span><br></pre></td></tr></table></figure><h4 id="2、PNG图片转Base64"><a href="#2、PNG图片转Base64" class="headerlink" title="2、PNG图片转Base64"></a>2、PNG图片转Base64</h4><p>不想以附件的形式发邮件了，就直接用base64图片返回的是HTML的IMG标签：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">img_to_base64_img</span><span class="params">(fileName)</span>:</span></span><br><span class="line">    img_file = open(fileName, <span class="string">'rb'</span>)</span><br><span class="line">    base64_data = base64.b64encode(img_file.read())</span><br><span class="line">    img_file.close()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'&lt;img src="data:image/png;base64,%s"&gt;'</span> % str(base64_data, <span class="string">"utf8"</span>)</span><br></pre></td></tr></table></figure><h4 id="3、发送邮件"><a href="#3、发送邮件" class="headerlink" title="3、发送邮件"></a>3、发送邮件</h4><p>没啥好说的，贴代码吧</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sent_email</span><span class="params">(sender, pwd, receiver, text, img_path)</span>:</span></span><br><span class="line">    host = <span class="string">'smtp.163.com'</span></span><br><span class="line">    port = <span class="number">465</span></span><br><span class="line">    body = img_to_base64_img(img_path)</span><br><span class="line">    msg = MIMEText(text + <span class="string">"&lt;br&gt;"</span> + body, <span class="string">'html'</span>)</span><br><span class="line">    msg[<span class="string">'subject'</span>] = <span class="string">'%s的课表'</span> % rq</span><br><span class="line">    msg[<span class="string">'from'</span>] = sender</span><br><span class="line">    msg[<span class="string">'to'</span>] = receiver</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s = smtplib.SMTP_SSL(host, port)</span><br><span class="line">        s.login(sender, pwd)</span><br><span class="line">        s.sendmail(sender, receiver, msg.as_string())</span><br><span class="line">        s.close()</span><br><span class="line">        print(<span class="string">'Done.sent email success'</span>)</span><br><span class="line">    <span class="keyword">except</span> smtplib.SMTPException:</span><br><span class="line">        print(<span class="string">'Error.sent email fail'</span>)</span><br></pre></td></tr></table></figure><p>然后在Linux设个定时任务就行了啦！</p><p><img src="https://cdn.looyeagee.cn/blog/img/2020/02/2546744912.jpg-blog" alt="图2:邮箱截图"></p></div><section class="post-copyright"><p class="copyright-item"><span>文章作者:</span> <span>LooyeaGee</span></p><p class="copyright-item"><span>文章链接:</span> <span><a href="https://looyeagee.cn/software/class_schedule/">https://looyeagee.cn/software/class_schedule/</a></span></p><p class="copyright-item"><span>版权声明:</span> <span>本博客采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a>进行许可</span></p></section><section class="post-tags"><div><span>标签:</span> <span class="tag"><a href="/tags/%E5%BC%BA%E6%99%BA/"># 强智</a> <a href="/tags/%E6%95%99%E5%8A%A1%E7%B3%BB%E7%BB%9F/"># 教务系统</a> <a href="/tags/%E8%AF%BE%E8%A1%A8/"># 课表</a></span></div><div><a href="javascript:window.history.back();">返回</a> <span>&nbsp;&nbsp; /&nbsp;&nbsp; </span><a href="/archives/">首页</a></div></section><section class="post-nav"><a class="prev" rel="prev" href="/zheteng/ctf/">我的CTF院赛出题记录</a> <a class="next" rel="next" href="/notes/MP/">Mybatis Plus带多条件的多表联合、分页、排序查询</a></section><br><br><section id="comments" class="comments"><style>.comments{margin:30px;padding:10px;background:#fff}@media screen and (max-width:800px){.comments{margin:auto;padding:10px;background:#fff}}</style><div class="valine_comment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>new Valine({el:".valine_comment",app_id:"GGS59T6lHdF3dH3fhiSJwu4G-MdYXbMMI",app_key:"mqefY3TJMDaBRqc44I7OdYtY",placeholder:"说点什么呗",notify:"false",verify:"false",avatar:"monsterid",visitor:!0})</script></section></article></div></div><footer id="footer" class="footer">访问总量：<span id="pv">加载中...</span><br><a href="http://beian.miit.gov.cn" target="__blank">湘ICP备19026259号-1</a> • <a target="_blank" style="line-height:18px" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=43018102000289"><img src="https://cdn.looyeagee.cn/blog/img/wangan.png" data-nobox="true" style="width:16px;height:16px;vertical-align:sub">湘公网安备43018102000289号</a><br>Copyright &copy; 2020 <a href="https://looyeagee.cn/">亦之日记</a> 的博客 • Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></footer><script>const path_name=decodeURI(window.location.pathname);$.ajax({type:"POST",url:"https://api.looyeagee.cn/api/visit"+path_name,success:function(t){$("#article_pv").html(t.hits),$("#pv").html(t.all)},error:function(t){}})</script></div></body></html>